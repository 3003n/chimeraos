#!/bin/bash

set -e
set -x

function download_decky_plugin() {
	local git_api_url="https://api.github.com/repos/$1/releases/latest"
	local decky_plugin_path=$2
	local grep_expression=${3:-".tar.gz"}

	local temp_decky
	temp_decky=$(mktemp -d)

	if [ -z "$temp_decky" ]; then
		echo "temp_decky is empty"
		return
	fi

	download_url=$(curl -s $git_api_url | grep "browser_download_url" | cut -d '"' -f 4 | grep $grep_expression) || true
	echo "download_url: $download_url"
	if [ -z "$download_url" ]; then
		echo "download_url is empty"
		return
	fi

	basename=$(basename $download_url)
	ext=${basename##*.}
	curl -L $download_url -o "${temp_decky}/${basename}"

	if [[ "$ext" == "gz" && "$basename" =~ \.tar\.gz ]]; then
		tar -xzvf "${temp_decky}/${basename}" -C $decky_plugin_path
	elif [ "$ext" == "zip" ]; then
		unzip -o "${temp_decky}/${basename}" -d $decky_plugin_path
	fi

	# delete node_modeules if exists
	rm -rf $decky_plugin_path/*/{node_modules,.git,.vscode}

	rm -rf $temp_decky
}

postinstall_download() {
	# pre download some
	pre_path=/usr/local/share/sk-pre
	decky_path=$pre_path/decky
	decky_file=$decky_path/PluginLoader
	decky_version_file=$decky_path/.loader.version
	decky_plugin_path=$pre_path/decky-plugins
	css_path=$pre_path/css
	css_hhd_path=$pre_path/css-hhd
	zsh_path=$pre_path/zsh
	refind_path=$pre_path/refind
	rime_config_path=$pre_path/rime_config

	# pre download decky
	mkdir -p $decky_path
	DECKY_RELEASE=$(curl -s 'https://api.github.com/repos/SteamDeckHomebrew/decky-loader/releases' | jq -r "first(.[])")
	DECKY_VERSION=$(jq -r '.tag_name' <<<${DECKY_RELEASE})
	DECKY_DOWNLOADURL=$(jq -r '.assets[].browser_download_url | select(endswith("PluginLoader"))' <<<${DECKY_RELEASE})
	curl -L $DECKY_DOWNLOADURL --output $decky_file
	echo $DECKY_VERSION >$decky_version_file

	# pre download decky plugins
	mkdir -p $decky_plugin_path

	# SDH-CssLoader
	download_decky_plugin "DeckThemes/SDH-CssLoader" $decky_plugin_path "SDH-CSSLoader-Decky.zip"

	# HHD-Decky
	download_decky_plugin "hhd-dev/hhd-decky" $decky_plugin_path

	# PowerControl
	download_decky_plugin "mengmeet/PowerControl" $decky_plugin_path

	# HueSync
	download_decky_plugin "honjow/HueSync" $decky_plugin_path

	# ToMoon
	download_decky_plugin "YukiCoco/ToMoon" $decky_plugin_path "tomoon.*\.zip"

	# GPD-WinControl
	download_decky_plugin "honjow/GPD-WinControl" $decky_plugin_path

	# decky-sk-box
	download_decky_plugin "honjow/decky-sk-box" $decky_plugin_path

	# aarron-lee/DeckyPlumber
	download_decky_plugin "aarron-lee/DeckyPlumber" $decky_plugin_path

	# honjow/decky-terminal/
	download_decky_plugin "honjow/decky-terminal" $decky_plugin_path

	# aarron-lee/LegionGoRemapper
	download_decky_plugin "aarron-lee/LegionGoRemapper" $decky_plugin_path

	# xXJSONDeruloXx/Decky-Framegen
	# download_decky_plugin "xXJSONDeruloXx/Decky-Framegen" $decky_plugin_path "Decky-Framegen.zip"

	# pre download css themes

	# pre download hhd css themes
	mkdir -p $css_hhd_path

	# SBP-Legion-Go-Theme
	# git_url="https://github.com/frazse/SBP-Legion-Go-Theme.git"
	# if [ -d $css_hhd_path/SBP-Legion-Go-Theme ]; then
	# 	rm -rf $css_hhd_path/SBP-Legion-Go-Theme
	# fi
	# git clone --depth 1 $git_url $css_hhd_path/SBP-Legion-Go-Theme
	# echo '{"active": true, "Apply": "Legion-Go-Theme"}' >$css_hhd_path/SBP-Legion-Go-Theme/config_USER.json

	# PSBP-PS5-to-Handheld
	git_url="https://github.com/honjow/SBP-PS5-to-Handheld.git"
	if [ -d $css_hhd_path/SBP-PS5-to-Handheld ]; then
		rm -rf $css_hhd_path/SBP-PS5-to-Handheld
	fi
	git clone --depth 1 $git_url $css_hhd_path/SBP-PS5-to-Handheld

	# pre download rime config
	rime_git_url="https://github.com/iDvel/rime-ice.git"
	if [ -d $rime_config_path ]; then
		rm -rf $rime_config_path
	fi
	git clone --depth 1 $rime_git_url $rime_config_path

	# zsh pre download
	mkdir -p "${zsh_path:?}"
	rm -rf "${zsh_path:?}"/*
	git clone --depth 1 https://github.com/ohmyzsh/ohmyzsh.git "${zsh_path:?}/ohmyzsh"
	git clone --depth 1 https://github.com/zdharma-continuum/fast-syntax-highlighting "${zsh_path:?}/ohmyzsh/custom/plugins/fast-syntax-highlighting"
	cp $zsh_path/ohmyzsh/templates/zshrc.zsh-template $zsh_path/.zshrc
	sed -i 's/ZSH_THEME="robbyrussell"/ZSH_THEME="ys"/g' $zsh_path/.zshrc
	sed -i 's/plugins=(git)/plugins=(git sudo z fast-syntax-highlighting)/g' $zsh_path/.zshrc
	cat >>$zsh_path/.zshrc <<-'EOM'
		
		######## sk-chimeraos functions ########
		# yazi
		function y() {
		    local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
		    yazi "$@" --cwd-file="$tmp"
		    if cwd="$(cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
		    builtin cd -- "$cwd"
		    fi
		    rm -f -- "$tmp"
		}
		function sy() {
		    local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
		    sudo yazi "$@" --cwd-file="$tmp"
		    if cwd="$(cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
		    builtin cd -- "$cwd"
		    fi
		    rm -f -- "$tmp"
		}
		######## sk-chimeraos functions end ########
		
	EOM

	# pre download refind themes
	mkdir -p $refind_path
	git clone --depth 1 "https://github.com/bobafetthotmail/refind-theme-regular.git" $refind_path/refind-theme-regular
	rm -rf $refind_path/refind-theme-regular/{.git,.gitignore,src,install.sh,README.md}

	# decky
	HOMEBREW_FOLDER="/home/${USERNAME}/homebrew"

	curl -sL https://raw.githubusercontent.com/SteamDeckHomebrew/decky-loader/main/dist/plugin_loader-release.service -o "/etc/systemd/system/plugin_loader.service"
	sed -i -e "s|\${HOMEBREW_FOLDER}|${HOMEBREW_FOLDER}|" "/etc/systemd/system/plugin_loader.service"

	# 强制软链接
	ln -sf "/usr/lib/systemd/system/hhd@.service" "/etc/systemd/system/multi-user.target.wants/hhd@${USERNAME}.service"
	ln -sf "/etc/systemd/system/plugin_loader.service" "/etc/systemd/system/multi-user.target.wants/plugin_loader.service"

	# UniversalAMDFormBrowser
	curl -sL "https://github.com/DavidS95/Smokeless_UMAF/raw/main/UniversalAMDFormBrowser.zip" -o "$pre_path/UMAF.zip"

}
