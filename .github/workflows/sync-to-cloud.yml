name: Sync to Cloud

on:
  # è‡ªåŠ¨è§¦å‘ï¼šå½“releaseåˆ›å»ºworkflowå®Œæˆæ—¶
  workflow_run:
    workflows: ["System image matrix build - stable", "System image matrix build - unstable", "Test CI"]
    types: [completed]
    
  # æ‰‹åŠ¨è§¦å‘ï¼šæ”¯æŒæŒ‡å®štagå‚æ•°
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'è¦åŒæ­¥çš„Releaseæ ‡ç­¾ (ç•™ç©ºåˆ™å¤„ç†æœ€æ–°ç‰ˆæœ¬)'
        required: false
        type: string
      force_sync:
        description: 'å¼ºåˆ¶é‡æ–°åŒæ­¥ (å³ä½¿å·²å­˜åœ¨)'
        required: false
        type: boolean
        default: false
      use_batch_download:
        description: 'å¯ç”¨å¤šçº¿ç¨‹æ‰¹é‡ä¸‹è½½æ¨¡å¼'
        required: false
        type: boolean
        default: true
      download_threads:
        description: 'ä¸‹è½½çº¿ç¨‹æ•°'
        required: false
        type: string
        default: '3'
      transfer_threads:
        description: 'ä¼ è¾“çº¿ç¨‹æ•°'
        required: false
        type: string
        default: '3'
      table_language:
        description: 'è¡¨æ ¼è¯­è¨€ (zh/en)'
        required: false
        type: choice
        options:
          - zh
          - en
        default: en
      use_emoji:
        description: 'æ˜¾ç¤ºEmojiå›¾æ ‡'
        required: false
        type: boolean
        default: false

jobs:
  sync-to-mobile-cloud:
    runs-on: ubuntu-latest
    # åªåœ¨æºworkflowæˆåŠŸæ—¶è¿è¡Œï¼Œæˆ–è€…æ˜¯æ‰‹åŠ¨è§¦å‘
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # - name: Free up disk space
      #   uses: jlumbroso/free-disk-space@main
      #   with:
      #     # this might remove tools that are actually needed,
      #     # if set to "true" but frees about 6 GB
      #     tool-cache: false
          
      #     # all of these default to true, but feel free to set to
      #     # "false" if necessary for your workflow
      #     android: true
      #     dotnet: true
      #     haskell: true
      #     large-packages: true
      #     docker-images: true
      #     swap-storage: true

      - name: Run mobile cloud sync script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MOBILE_CLOUD_AUTHORIZATION: ${{ secrets.MOBILE_CLOUD_AUTHORIZATION }}
          # ä¸‹è½½æ¨¡å¼é…ç½®ç¯å¢ƒå˜é‡
          USE_BATCH_DOWNLOAD: ${{ inputs.use_batch_download }}
          BATCH_DOWNLOAD_THREADS: ${{ inputs.download_threads }}
          BATCH_TRANSFER_THREADS: ${{ inputs.transfer_threads }}
          TABLE_LANGUAGE: ${{ inputs.table_language }}
          USE_EMOJI: ${{ inputs.use_emoji }}
          FORCE_SYNC: ${{ inputs.force_sync }}
        run: |
          # è°ƒè¯•ï¼šæ˜¾ç¤ºåŸå§‹è¾“å…¥å€¼
          # echo "ğŸ› è°ƒè¯•ä¿¡æ¯ï¼š"
          # echo "  inputs.table_language: '${{ inputs.table_language }}'"
          # echo "  inputs.use_emoji: '${{ inputs.use_emoji }}'"
          # echo "  inputs.force_sync: '${{ inputs.force_sync }}'"
          # echo "  inputs.use_batch_download: '${{ inputs.use_batch_download }}'"
          # echo ""
          
          # æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
          if [ -z "$MOBILE_CLOUD_AUTHORIZATION" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç§»åŠ¨äº‘ç›˜è®¤è¯ä¿¡æ¯"
            echo "è¯·åœ¨ä»“åº“Secretsä¸­è®¾ç½® MOBILE_CLOUD_AUTHORIZATION"
            exit 1
          fi
          
          # ç¡®å®šå‚æ•°
          TAG_NAME="${{ inputs.tag_name }}"

          USE_BATCH_DOWNLOAD="${USE_BATCH_DOWNLOAD:-true}"  # true: å¤šçº¿ç¨‹æ‰¹é‡ä¸‹è½½, false: å•æ–‡ä»¶ä¸‹è½½
          BATCH_DOWNLOAD_THREADS="${BATCH_DOWNLOAD_THREADS:-3}"   # æ‰¹é‡ä¸‹è½½çº¿ç¨‹æ•°
          BATCH_TRANSFER_THREADS="${BATCH_TRANSFER_THREADS:-3}"   # æ‰¹é‡ä¼ è¾“çº¿ç¨‹æ•°
          TABLE_LANGUAGE="${TABLE_LANGUAGE:-en}"      # è¡¨æ ¼è¯­è¨€: zh(ä¸­æ–‡) æˆ– en(è‹±æ–‡)
          USE_EMOJI="${USE_EMOJI:-true}"           # æ˜¯å¦åœ¨çŠ¶æ€ä¸­æ˜¾ç¤ºemoji
          FORCE_SYNC="${FORCE_SYNC:-false}"       # å¼ºåˆ¶åŒæ­¥æ¨¡å¼

          export USE_BATCH_DOWNLOAD
          export BATCH_DOWNLOAD_THREADS
          export BATCH_TRANSFER_THREADS
          export TABLE_LANGUAGE
          export USE_EMOJI
          export FORCE_SYNC
          
          # æ˜¾ç¤ºé…ç½®
          echo "ğŸ”§ åŒæ­¥é…ç½®:"
          echo "  ğŸ“ Releaseæ ‡ç­¾: ${TAG_NAME:-'æœ€æ–°ç‰ˆæœ¬'}"
          echo "  ğŸ”„ å¼ºåˆ¶åŒæ­¥: $FORCE_SYNC"
          echo "  âš¡ æ‰¹é‡ä¸‹è½½: $USE_BATCH_DOWNLOAD"
          echo "  ğŸ“¥ ä¸‹è½½çº¿ç¨‹: $BATCH_DOWNLOAD_THREADS"
          echo "  ğŸ“¤ ä¼ è¾“çº¿ç¨‹: $BATCH_TRANSFER_THREADS"
          echo "  ğŸŒ è¡¨æ ¼è¯­è¨€: $TABLE_LANGUAGE"
          echo "  ğŸ˜Š æ˜¾ç¤ºEmoji: $USE_EMOJI"
          echo ""
          
          # è¿è¡ŒåŒæ­¥è„šæœ¬
          ./.github/scripts/cloud-sync.sh "$TAG_NAME" "$GITHUB_TOKEN" "$MOBILE_CLOUD_AUTHORIZATION"
