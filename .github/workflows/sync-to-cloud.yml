name: Sync to Cloud

on:
  # 自动触发：当release创建workflow完成时
  workflow_run:
    workflows: ["System image matrix build - stable", "System image matrix build - unstable", "Test CI"]
    types: [completed]
    
  # 手动触发：支持指定tag参数
  workflow_dispatch:
    inputs:
      tag_name:
        description: '要同步的Release标签 (留空则处理最新版本)'
        required: false
        type: string
      force_sync:
        description: '强制重新同步 (即使已存在)'
        required: false
        type: boolean
        default: false
      use_batch_download:
        description: '启用多线程批量下载模式'
        required: false
        type: boolean
        default: true
      download_threads:
        description: '下载线程数'
        required: false
        type: string
        default: '3'
      transfer_threads:
        description: '传输线程数'
        required: false
        type: string
        default: '3'
      table_language:
        description: '表格语言 (zh/en)'
        required: false
        type: choice
        options:
          - zh
          - en
        default: en
      use_emoji:
        description: '显示Emoji图标'
        required: false
        type: boolean
        default: false

jobs:
  sync-to-mobile-cloud:
    runs-on: ubuntu-latest
    # 只在源workflow成功时运行，或者是手动触发
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # - name: Free up disk space
      #   uses: jlumbroso/free-disk-space@main
      #   with:
      #     # this might remove tools that are actually needed,
      #     # if set to "true" but frees about 6 GB
      #     tool-cache: false
          
      #     # all of these default to true, but feel free to set to
      #     # "false" if necessary for your workflow
      #     android: true
      #     dotnet: true
      #     haskell: true
      #     large-packages: true
      #     docker-images: true
      #     swap-storage: true

      - name: Run mobile cloud sync script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MOBILE_CLOUD_AUTHORIZATION: ${{ secrets.MOBILE_CLOUD_AUTHORIZATION }}
          # 下载模式配置环境变量
          USE_BATCH_DOWNLOAD: ${{ inputs.use_batch_download }}
          BATCH_DOWNLOAD_THREADS: ${{ inputs.download_threads }}
          BATCH_TRANSFER_THREADS: ${{ inputs.transfer_threads }}
          TABLE_LANGUAGE: ${{ inputs.table_language }}
          USE_EMOJI: ${{ inputs.use_emoji }}
          FORCE_SYNC: ${{ inputs.force_sync }}
        run: |
          # 调试：显示原始输入值
          # echo "🐛 调试信息："
          # echo "  inputs.table_language: '${{ inputs.table_language }}'"
          # echo "  inputs.use_emoji: '${{ inputs.use_emoji }}'"
          # echo "  inputs.force_sync: '${{ inputs.force_sync }}'"
          # echo "  inputs.use_batch_download: '${{ inputs.use_batch_download }}'"
          # echo ""
          
          # 检查必需的环境变量
          if [ -z "$MOBILE_CLOUD_AUTHORIZATION" ]; then
            echo "❌ 未找到移动云盘认证信息"
            echo "请在仓库Secrets中设置 MOBILE_CLOUD_AUTHORIZATION"
            exit 1
          fi
          
          # 确定参数
          TAG_NAME="${{ inputs.tag_name }}"

          USE_BATCH_DOWNLOAD="${USE_BATCH_DOWNLOAD:-true}"  # true: 多线程批量下载, false: 单文件下载
          BATCH_DOWNLOAD_THREADS="${BATCH_DOWNLOAD_THREADS:-3}"   # 批量下载线程数
          BATCH_TRANSFER_THREADS="${BATCH_TRANSFER_THREADS:-3}"   # 批量传输线程数
          TABLE_LANGUAGE="${TABLE_LANGUAGE:-en}"      # 表格语言: zh(中文) 或 en(英文)
          USE_EMOJI="${USE_EMOJI:-true}"           # 是否在状态中显示emoji
          FORCE_SYNC="${FORCE_SYNC:-false}"       # 强制同步模式

          export USE_BATCH_DOWNLOAD
          export BATCH_DOWNLOAD_THREADS
          export BATCH_TRANSFER_THREADS
          export TABLE_LANGUAGE
          export USE_EMOJI
          export FORCE_SYNC
          
          # 显示配置
          echo "🔧 同步配置:"
          echo "  📁 Release标签: ${TAG_NAME:-'最新版本'}"
          echo "  🔄 强制同步: $FORCE_SYNC"
          echo "  ⚡ 批量下载: $USE_BATCH_DOWNLOAD"
          echo "  📥 下载线程: $BATCH_DOWNLOAD_THREADS"
          echo "  📤 传输线程: $BATCH_TRANSFER_THREADS"
          echo "  🌐 表格语言: $TABLE_LANGUAGE"
          echo "  😊 显示Emoji: $USE_EMOJI"
          echo ""
          
          # 运行同步脚本
          ./.github/scripts/cloud-sync.sh "$TAG_NAME" "$GITHUB_TOKEN" "$MOBILE_CLOUD_AUTHORIZATION"
